function Cart(t){function e(t){for(var e=0,a=0,r=0;r<t.length;r++)e+=1*t[r].qty,a+=1*t[r].cost*(1*t[r].qty);return{count:e,summ:a.formatMoney(2,","," ")}}function a(t,e){return t.name==e}var r=this,n=new CustomEvent("build");t?this.items=JSON.parse(t)||[]:this.items=[],this.addItem=function(t){for(var e=!1,r=0;r<this.items.length;r++)a(this.items[r],t.name)&&(this.items[r].qty+=1,e=!0);e||this.items.push(t),window.dispatchEvent(n)},this.removeItem=function(t){for(var e=0;e<this.items.length;e++)a(this.items[e],t)&&this.items.splice(e,1);window.dispatchEvent(n)},this.changeItem=function(t,e){for(var r=0;r<this.items.length;r++)a(this.items[r],t)&&(this.items[r].qty=e);window.dispatchEvent(n)},this.releaseCart=function(){this.items=[],jQuery.cookie("cart","",{path:"/"}),window.dispatchEvent(n)},this.renderCartConsole=function(){console.log("==== CART ====");for(var t=0;t<r.items.length;t++)console.log(r.items[t].name+" => "+r.items[t].qty);console.log("Count items: "+r.getCount())},this.getBlockData=function(){for(var t=0,e=0,a=0;a<this.items.length;a++)t+=1*this.items[a].qty,e+=1*this.items[a].cost*(1*this.items[a].qty);return{count:t,summ:e.formatMoney(2,","," ")}},this.renderCheckout=function(){var t='<div class="cart-checkout">';t+="<h2>Оформите ваш заказ</h2>",t+='<div class="cart-form-user-data"><div class="line-field"><label for="username">Ваше имя</label><input required type="text" name="username" id="username"></div><div class="line-field"><label for="email">Ваш email</label><input required type="email" name="email" id="email"></div><div class="line-field"><label for="tel">Ваш телефон</label><input type="tel" name="tel" id="tel"></div></div>',t+='<ul class="cart-checkout-list">';for(var a=0;r.items.length>a;a++)t+='<li><span class="name" title='+r.items[a].name+">"+r.items[a].name.substr(0,100)+'</span> <input type="number" class="qty" name="qty" min="1" value="'+r.items[a].qty+'" data-name="'+r.items[a].name+'"> <a href="#" class="del" data-name="'+r.items[a].name+'">X</a></li>';return t+="</ul>",t+='<div class="result"><strong>Всего товаров: </strong>'+e(r.items).count+"</br><strong>Итого: </strong>"+e(r.items).summ+" руб.</div>",t+='<div class="cart-send-line"><button class="btn-send-order">Отправить заказ</button></div>'},this.checkout=function(){},this.cartSave=function(){jQuery.cookie("cart",JSON.stringify(this.items),{path:"/"})},this.getSum=function(){for(var t=0,e=0;e<r.items.length;e++)t+=1*r.items[e].cost*(1*r.items[e].qty);return t},this.getCount=function(){return r.items.length}}Number.prototype.formatMoney=function(t,e,a){var r=this,t=isNaN(t=Math.abs(t))?2:t,e=void 0==e?".":e,a=void 0==a?",":a,n=r<0?"-":"",i=String(parseInt(r=Math.abs(Number(r)||0).toFixed(t))),s=(s=i.length)>3?s%3:0;return n+(s?i.substr(0,s)+a:"")+i.substr(s).replace(/(\d{3})(?=\d)/g,"$1"+a)+(t?e+Math.abs(r-i).toFixed(t).slice(2):"")},function(){function t(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var a=document.createEvent("CustomEvent");return a.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),a}t.prototype=window.Event.prototype,window.CustomEvent=t}(),jQuery(function(t){function e(){var e=t(".cart-form-user-data #username").val(),a=t(".cart-form-user-data #email").val(),r=t(".cart-form-user-data #tel").val();return{username:e,email:a,tel:r}}function a(e){t(".cart-form-user-data #username").val(e.username),t(".cart-form-user-data #email").val(e.email),t(".cart-form-user-data #tel").val(e.tel)}function r(e){var a=!0,r=t(".cart-form-user-data #email").val();t(".cart-form-user-data input").each(function(e,r){t(this).attr("required")&&!t(this).val()&&(t(this).css("border-color","red"),a=!1)}),t.post("/simple-cart/mailcheck",{email:r}).done(function(r){r.mail_exists||(t(".cart-form-user-data #email").css("border-color","red"),a=!1),e(a)})}myCart=new Cart(t.cookie("cart")),window.addEventListener("build",function(){myCart.getBlockData(),myCart.cartSave(),t(".cart-badge").text(myCart.getBlockData().count),t(".cart-cost").text(myCart.getBlockData().summ+" руб."),t(".view-taxonomynode .btn-add-to-cart").each(function(e,a){for(var r=0;r<myCart.items.length;r++)t(this).data("name")==myCart.items[r].name&&t(this).parents("tr").addClass("js-in-cart")}),t("#cboxLoadedContent").html(myCart.renderCheckout()),t(".cart-checkout .del").click(function(e){e.preventDefault(),myCart.removeItem(t(this).data("name"))}),t(".cart-checkout .qty").change(function(e){t(this).val()<=0&&myCart.removeItem(t(this).data("name")),myCart.changeItem(t(this).data("name"),t(this).val())}),t.cookie("cart-user")&&a(JSON.parse(t.cookie("cart-user"))),t(".cart-form-user-data input").change(function(a){t.cookie("cart-user",JSON.stringify(e()),{path:"/"})}),t(".btn-send-order").click(function(a){r(function(a){if(a){var r={};r=e(),t.post("/simple-cart/send",{items:myCart.items,count:myCart.getCount(),summ:myCart.getSum(),user:r}).done(function(e){t.colorbox.close(),myCart.releaseCart(),setTimeout('location="/simple-cart/message";',1e3)})}})}),t(".view-taxonomynode tr").removeClass("js-in-cart"),t(".view-taxonomynode .btn-add-to-cart").each(function(e,a){for(var r=0;r<myCart.items.length;r++)t(this).data("name")==myCart.items[r].name&&t(this).parents("tr").addClass("js-in-cart")})},!1),t(".cart-badge").text(myCart.getBlockData().count),t(".cart-cost").text(myCart.getBlockData().summ+" руб."),t(".view-taxonomynode .btn-add-to-cart").each(function(e,a){for(var r=0;r<myCart.items.length;r++)t(this).data("name")==myCart.items[r].name&&t(this).parents("tr").addClass("js-in-cart")}),t(".btn-add-to-cart").click(function(e){e.preventDefault();var a={name:t(this).data("name"),cost:t(this).data("cost"),qty:1};myCart.addItem(a)}),t(".cart-block").click(function(n){t.colorbox({html:myCart.renderCheckout}),t(".cart-checkout .del").click(function(e){e.preventDefault(),myCart.removeItem(t(this).data("name"))}),t(".cart-checkout .qty").change(function(e){t(this).val()<=0&&myCart.removeItem(t(this).data("name")),myCart.changeItem(t(this).data("name"),t(this).val())}),t.cookie("cart-user")&&a(JSON.parse(t.cookie("cart-user"))),t(".cart-form-user-data input").change(function(a){t.cookie("cart-user",JSON.stringify(e()))}),t(".btn-send-order").click(function(a){r(function(a){if(a){var r={};r=e(),t.post("/simple-cart/send",{items:myCart.items,count:myCart.getCount(),summ:myCart.getSum(),user:r}).done(function(e){t.colorbox.close(),myCart.releaseCart(),setTimeout('location="/simple-cart/message";',1e3)})}})})})});