function Cart(t){function e(t){for(var e=0,a=0,i=0;i<t.length;i++)e+=1*t[i].qty,a+=1*t[i].cost*(1*t[i].qty);return{count:e,summ:a}}function a(t,e){return t.name==e}var i=this,r=new Event("build");t?this.items=JSON.parse(t)||[]:this.items=[],this.addItem=function(t){for(var e=!1,i=0;i<this.items.length;i++)a(this.items[i],t.name)&&(this.items[i].qty+=1,e=!0);e||this.items.push(t),window.dispatchEvent(r)},this.removeItem=function(t){for(var e=0;e<this.items.length;e++)a(this.items[e],t)&&this.items.splice(e,1);window.dispatchEvent(r)},this.changeItem=function(t,e){for(var i=0;i<this.items.length;i++)a(this.items[i],t)&&(this.items[i].qty=e);window.dispatchEvent(r)},this.releaseCart=function(){this.items=[],jQuery.cookie("cart","",{path:"/"}),window.dispatchEvent(r)},this.renderCartConsole=function(){console.log("==== CART ====");for(var t=0;t<i.items.length;t++)console.log(i.items[t].name+" => "+i.items[t].qty);console.log("Count items: "+i.getCount())},this.isInCart,this.getBlockData=function(){for(var t=0,e=0,a=0;a<this.items.length;a++)t+=1*this.items[a].qty,e+=1*this.items[a].cost*(1*this.items[a].qty);return{count:t,summ:e}},this.renderCheckout=function(){var t='<div class="cart-checkout">';t+="<h2>Оформите ваш заказ</h2>",t+='<div class="cart-form-user-data"><div class="line-field"><label for="username">Ваше имя</label><input required type="text" name="username" id="username"></div><div class="line-field"><label for="email">Ваш email</label><input required type="email" name="email" id="email"></div><div class="line-field"><label for="tel">Ваш телефон</label><input type="tel" name="tel" id="tel"></div></div>',t+='<ul class="cart-checkout-list">';for(var a=0;i.items.length>a;a++)t+='<li><span class="name" title='+i.items[a].name+">"+i.items[a].name.substr(0,100)+'</span> <input type="number" class="qty" name="qty" min="1" value="'+i.items[a].qty+'" data-name="'+i.items[a].name+'"> <a href="#" class="del" data-name="'+i.items[a].name+'">X</a></li>';return t+="</ul>",t+='<div class="result"><strong>Всего товаров: </strong>'+e(i.items).count+"</br><strong>Итого: </strong>"+e(i.items).summ+" руб.</div>",t+='<div class="cart-send-line"><button class="btn-send-order">Отправить заказ</button></div>'},this.checkout=function(){},this.cartSave=function(){jQuery.cookie("cart",JSON.stringify(this.items),{path:"/"})},this.getSum=function(){for(var t=0,e=0;e<i.items.length;e++)t+=1*i.items[e].cost*(1*i.items[e].qty);return t},this.getCount=function(){return i.items.length}}jQuery(function(t){function e(){var e=t(".cart-form-user-data #username").val(),a=t(".cart-form-user-data #email").val(),i=t(".cart-form-user-data #tel").val();return{username:e,email:a,tel:i}}function a(e){t(".cart-form-user-data #username").val(e.username),t(".cart-form-user-data #email").val(e.email),t(".cart-form-user-data #tel").val(e.tel)}function i(e){var a=!0,i=t(".cart-form-user-data #email").val();t(".cart-form-user-data input").each(function(e,i){t(this).attr("required")&&!t(this).val()&&(t(this).css("border-color","red"),a=!1)}),t.post("/simple-cart/mailcheck",{email:i}).done(function(i){i.mail_exists||(t(".cart-form-user-data #email").css("border-color","red"),a=!1),e(a)})}myCart=new Cart(t.cookie("cart")),window.addEventListener("build",function(){myCart.getBlockData(),myCart.cartSave(),t(".cart-badge").text(myCart.getBlockData().count),t(".cart-cost").text(myCart.getBlockData().summ+" руб."),t(".view-taxonomynode .btn-add-to-cart").each(function(e,a){for(var i=0;i<myCart.items.length;i++)t(this).data("name")==myCart.items[i].name&&t(this).parents("tr").addClass("js-in-cart")}),t("#cboxLoadedContent").html(myCart.renderCheckout()),t(".cart-checkout .del").click(function(e){e.preventDefault(),myCart.removeItem(t(this).data("name"))}),t(".cart-checkout .qty").change(function(e){t(this).val()<=0&&myCart.removeItem(t(this).data("name")),myCart.changeItem(t(this).data("name"),t(this).val())}),t.cookie("cart-user")&&a(JSON.parse(t.cookie("cart-user"))),t(".cart-form-user-data input").change(function(a){t.cookie("cart-user",JSON.stringify(e()),{path:"/"})}),t(".btn-send-order").click(function(a){i(function(a){if(a){var i={};i=e(),t.post("/simple-cart/send",{items:myCart.items,count:myCart.getCount(),summ:myCart.getSum(),user:i}).done(function(e){t.colorbox.close(),myCart.releaseCart(),setTimeout('location="/simple-cart/message";',1e3)})}})}),t(".view-taxonomynode tr").removeClass("js-in-cart"),t(".view-taxonomynode .btn-add-to-cart").each(function(e,a){for(var i=0;i<myCart.items.length;i++)t(this).data("name")==myCart.items[i].name&&t(this).parents("tr").addClass("js-in-cart")})},!1),t(".cart-badge").text(myCart.getBlockData().count),t(".cart-cost").text(myCart.getBlockData().summ+" руб."),t(".view-taxonomynode .btn-add-to-cart").each(function(e,a){for(var i=0;i<myCart.items.length;i++)t(this).data("name")==myCart.items[i].name&&t(this).parents("tr").addClass("js-in-cart")}),t(".btn-add-to-cart").click(function(e){e.preventDefault();var a={name:t(this).data("name"),cost:t(this).data("cost"),qty:1};myCart.addItem(a)}),t(".cart-block").click(function(r){t.colorbox({html:myCart.renderCheckout}),t(".cart-checkout .del").click(function(e){e.preventDefault(),myCart.removeItem(t(this).data("name"))}),t(".cart-checkout .qty").change(function(e){t(this).val()<=0&&myCart.removeItem(t(this).data("name")),myCart.changeItem(t(this).data("name"),t(this).val())}),t.cookie("cart-user")&&a(JSON.parse(t.cookie("cart-user"))),t(".cart-form-user-data input").change(function(a){t.cookie("cart-user",JSON.stringify(e()))}),t(".btn-send-order").click(function(a){i(function(a){if(a){var i={};i=e(),t.post("/simple-cart/send",{items:myCart.items,count:myCart.getCount(),summ:myCart.getSum(),user:i}).done(function(e){t.colorbox.close(),myCart.releaseCart(),setTimeout('location="/simple-cart/message";',1e3)})}})})})});