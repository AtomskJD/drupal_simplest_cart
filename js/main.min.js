function Cart(t){function e(t){for(var e=0,a=0,s=0;s<t.length;s++)e+=1*t[s].qty,a+=1*t[s].cost*(1*t[s].qty);return{count:e,summ:a.formatMoney(2,","," ")}}function a(t,e){return t.name==e}var s=this,n=new CustomEvent("build");this.items=t?JSON.parse(t)||[]:[],this.addItem=function(t){for(var e=!1,s=0;s<this.items.length;s++)a(this.items[s],t.name)&&(this.items[s].qty+=1,e=!0);e||this.items.push(t),window.dispatchEvent(n)},this.removeItem=function(t){for(var e=0;e<this.items.length;e++)a(this.items[e],t)&&this.items.splice(e,1);window.dispatchEvent(n)},this.changeItem=function(t,e){for(var s=0;s<this.items.length;s++)a(this.items[s],t)&&(this.items[s].qty=e);window.dispatchEvent(n)},this.releaseCart=function(){this.items=[],jQuery.cookie("cart","",{path:"/"}),window.dispatchEvent(n)},this.renderCartConsole=function(){console.log("==== CART ====");for(var t=0;t<s.items.length;t++)console.log(s.items[t].name+" => "+s.items[t].qty);console.log("Count items: "+s.getCount())},this.getBlockData=function(){for(var t=0,e=0,a=0;a<this.items.length;a++)t+=1*this.items[a].qty,e+=1*this.items[a].cost*(1*this.items[a].qty);return{count:t,summ:e.formatMoney(2,","," ")}},this.renderCheckout=function(){var t='<div class="cart-checkout">';t+="<h2>Оформите ваш заказ</h2>",t+='<div class="cart-form-user-data"><div class="line-field"><label for="username">Ваше имя/Наименование организации</label><input required type="text" name="username" id="username"></div><div class="line-field"><label for="email">Ваш email</label><input required type="email" name="email" id="email"></div><div class="line-field"><label for="tel">Ваш телефон</label><input type="tel" name="tel" id="tel"></div><div class="line-field"><label for="file">Прикрепить реквизиты</label><input type="file" name="file" id="file"></div></div>',t+='<ul class="cart-checkout-list">';for(var a=0;s.items.length>a;a++)t+='<li><span class="name" title='+s.items[a].name+">"+s.items[a].name.substr(0,100)+'</span> <input type="number" class="qty" name="qty" min="1" value="'+s.items[a].qty+'" data-name="'+s.items[a].name+'"> <a href="#" class="del" data-name="'+s.items[a].name+'">X</a></li>';return t+="</ul>",t+='<div class="result"><strong>Всего товаров: </strong>'+e(s.items).count+"</br><strong>Итого: </strong>"+e(s.items).summ+" руб.</div>",t+='<div class="cart-send-line"><button class="btn-send-order">Отправить заказ</button></div>'},this.checkout=function(){},this.cartSave=function(){jQuery.cookie("cart",JSON.stringify(this.items),{path:"/"})},this.getSum=function(){for(var t=0,e=0;e<s.items.length;e++)t+=1*s.items[e].cost*(1*s.items[e].qty);return t},this.getCount=function(){return s.items.length}}Number.prototype.formatMoney=function(t,e,a){var s=this,t=isNaN(t=Math.abs(t))?2:t,e=void 0==e?".":e,a=void 0==a?",":a,n=s<0?"-":"",r=String(parseInt(s=Math.abs(Number(s)||0).toFixed(t))),o=(o=r.length)>3?o%3:0;return n+(o?r.substr(0,o)+a:"")+r.substr(o).replace(/(\d{3})(?=\d)/g,"$1"+a)+(t?e+Math.abs(s-r).toFixed(t).slice(2):"")},function(){function t(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var a=document.createEvent("CustomEvent");return a.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),a}t.prototype=window.Event.prototype,window.CustomEvent=t}(),jQuery(function(t){function e(){return{username:t(".cart-form-user-data #username").val(),email:t(".cart-form-user-data #email").val(),tel:t(".cart-form-user-data #tel").val()}}function a(e){t(".cart-form-user-data #username").val(e.username),t(".cart-form-user-data #email").val(e.email),t(".cart-form-user-data #tel").val(e.tel)}function s(e){var a=!0,s=t(".cart-form-user-data #email").val();t(".cart-form-user-data input").each(function(e,s){t(this).attr("required")&&!t(this).val()&&(t(this).css("border-color","red"),a=!1)}),t.post("/simple-cart/mailcheck",{email:s}).done(function(s){s.mail_exists||(t(".cart-form-user-data #email").css("border-color","red"),a=!1),e(a)})}myCart=new Cart(t.cookie("cart")),window.addEventListener("build",function(){myCart.getBlockData(),myCart.cartSave(),t(".cart-badge").text(myCart.getBlockData().count),t(".cart-cost").text(myCart.getBlockData().summ+" руб."),t(".view-taxonomynode .btn-add-to-cart").each(function(e,a){for(var s=0;s<myCart.items.length;s++)t(this).data("name")==myCart.items[s].name&&t(this).parents("tr").addClass("js-in-cart")}),t("#cboxLoadedContent").html(myCart.renderCheckout()),t(".cart-checkout .del").click(function(e){e.preventDefault(),myCart.removeItem(t(this).data("name"))}),t(".cart-checkout .qty").change(function(e){t(this).val()<=0&&myCart.removeItem(t(this).data("name")),myCart.changeItem(t(this).data("name"),t(this).val())}),t.cookie("cart-user")&&a(JSON.parse(t.cookie("cart-user"))),t(".cart-form-user-data input").change(function(a){t.cookie("cart-user",JSON.stringify(e()),{path:"/"})});var n;t("input#files").change(function(t){n=this.files}),console.log("send 1"),t(".btn-send-order").click(function(a){s(function(a){if(a){var s={};if(s=e(),n){console.log(n);var r=new FormData;t.each(n,function(t,e){r.append(t,e)}),t.ajax({url:"/simple-cart/send?files",type:"POST",data:r,cache:!1,dataType:"text",processData:!1,contentType:!1,success:function(e,a,n){void 0===e.error?(console.log(e),console.log(JSON.parse(e).files),t.post("/simple-cart/send",{items:myCart.items,count:myCart.getCount(),summ:myCart.getSum(),user:s,files:JSON.parse(e).files}).done(function(e){t.colorbox.close(),myCart.releaseCart(),setTimeout('location="/simple-cart/message";',1e3)})):console.log("SERVER ERRORS: "+e.error)},error:function(t,e,a){console.log("AJAX ERRORS: "+e)}})}else console.log(n),t.post("/simple-cart/send",{items:myCart.items,count:myCart.getCount(),summ:myCart.getSum(),user:s}).done(function(e){t.colorbox.close(),myCart.releaseCart(),setTimeout('location="/simple-cart/message";',1e3)})}})}),t(".view-taxonomynode tr").removeClass("js-in-cart"),t(".view-taxonomynode .btn-add-to-cart").each(function(e,a){for(var s=0;s<myCart.items.length;s++)t(this).data("name")==myCart.items[s].name&&t(this).parents("tr").addClass("js-in-cart")})},!1),t(".cart-badge").text(myCart.getBlockData().count),t(".cart-cost").text(myCart.getBlockData().summ+" руб."),t(".view-taxonomynode .btn-add-to-cart").each(function(e,a){for(var s=0;s<myCart.items.length;s++)t(this).data("name")==myCart.items[s].name&&t(this).parents("tr").addClass("js-in-cart")}),t(".btn-add-to-cart").click(function(e){e.preventDefault();var a={name:t(this).data("name"),cost:t(this).data("cost"),qty:1};myCart.addItem(a)}),t(".cart-block").click(function(n){t.colorbox({html:myCart.renderCheckout}),t(".cart-checkout .del").click(function(e){e.preventDefault(),myCart.removeItem(t(this).data("name"))}),t(".cart-checkout .qty").change(function(e){t(this).val()<=0&&myCart.removeItem(t(this).data("name")),myCart.changeItem(t(this).data("name"),t(this).val())}),t.cookie("cart-user")&&a(JSON.parse(t.cookie("cart-user"))),t(".cart-form-user-data input").change(function(a){t.cookie("cart-user",JSON.stringify(e()))});var r;t("input#file").change(function(t){r=this.files}),t(".btn-send-order").click(function(a){s(function(a){if(a){var s={};if(s=e(),r){console.log(r);var n=new FormData;t.each(r,function(t,e){n.append(t,e)}),t.ajax({url:"/simple-cart/send?files",type:"POST",data:n,cache:!1,dataType:"text",processData:!1,contentType:!1,success:function(e,a,n){void 0===e.error?(console.log(e),console.log(JSON.parse(e).files),t.post("/simple-cart/send",{items:myCart.items,count:myCart.getCount(),summ:myCart.getSum(),user:s,files:JSON.parse(e).files}).done(function(e){t.colorbox.close(),myCart.releaseCart(),setTimeout('location="/simple-cart/message";',1e3)})):console.log("SERVER ERRORS: "+e.error)},error:function(t,e,a){console.log("AJAX ERRORS: "+e)}})}else console.log(r),t.post("/simple-cart/send",{items:myCart.items,count:myCart.getCount(),summ:myCart.getSum(),user:s}).done(function(e){t.colorbox.close(),myCart.releaseCart(),setTimeout('location="/simple-cart/message";',1e3)})}})})})});